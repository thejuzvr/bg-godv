### Расширение текстового контента: мысли и диалоги (дорожная карта)

Цель: значительно увеличить разнообразие мыслей героя и реплик NPC по аналогии с godville.net за счёт вынесения контента в БД, контекстного выбора с весами и анти‑повтора, а также полноценного CRUD в админ‑панели.

---

### 1) Новая таблица game_thoughts (мысли героя)

Предлагаемая схема (PostgreSQL / Drizzle):
- id: text (PK)
- text: text — локализуемая строка (может содержать плейсхолдеры: {heroName}, {city}, {weather}, ...)
- tags: text[] — произвольные метки для группировки/аналитики (meme, lore, rare, seasonal_...)
- conditions: jsonb — условия показа (см. ниже)
- weight: integer — вес для взвешенного выбора (по умолчанию 1)
- cooldownKey: text | null — ключ “охлаждения” для анти‑повтора (например, same_text_id)
- locale: text — 'ru', 'en' и т.п.
- isEnabled: boolean — для мягкого отключения
- createdAt/updatedAt: timestamp

Пример conditions:
```
{
  "status": ["idle", "travel", "in-city"],
  "weather": ["Rain", "Clear"],
  "moodMin": 40,
  "moodMax": 100,
  "hpBelow": 0.3,
  "locations": ["whiterun", "solitude"],
  "timeOfDay": ["day", "evening"],
  "season": ["winter", "summer"],
  "factionsAny": ["companions"],
  "questFlagsAny": ["main_started"]
}
```

---

### 2) Расширение диалогов NPC

Вместо простого массива строк в `game_npcs.dialogue` — новая таблица `npc_dialogue_lines`:
- id: text (PK)
- npcId: text (FK -> game_npcs.id)
- text: text
- tags: text[]
- conditions: jsonb (аналогично game_thoughts)
- weight: integer
- cooldownKey: text | null
- locale: text
- isEnabled: boolean
- createdAt/updatedAt: timestamp

Причины: проще фильтровать/весить/переиспользовать, удобный CRUD, импорт/экспорт.

---

### 3) Админ‑панель (Менеджер данных)

Добавить вкладку «Мысли» (game_thoughts):
- Таблица с фильтрами по tags/locale/enabled.
- Форма редактирования: text, tags (мультивыбор), conditions (UI‑конструктор + JSON), weight, cooldownKey, locale, isEnabled.
- Импорт/экспорт JSON, форматирование и валидация JSON полей.

Расширить редактор NPC:
- Подтаблица «Реплики» для данного NPC (пагинация): CRUD для `npc_dialogue_lines`.
- Те же UX‑паттерны: теги, условия, веса, включено/выключено, импорт/экспорт.

---

### 4) Логика выбора (взвешенный семплинг + анти‑повтор)

Единый отбор для мыслей и реплик:
1) Сформировать контекст героя: статус, локация, погода, mood, hp%, активные квесты, фракции, время суток, сезон, отношения с NPC и т.д.
2) Отфильтровать записи, чьи `conditions` совпадают (быстрые предикаты; пустые условия считаются универсальными).
3) Исключить записи, которые под cooldown (последние N минут/тиков по cooldownKey/по id) — хранить последнее показанное в `characters.analytics` или отдельной таблице `content_cooldowns`.
4) Провести взвешенный выбор по полю `weight` с дополнительным «variety‑boost»: чем реже текст показывался этому герою — тем больше множитель веса.
5) Поддержать «редкие» фразы (tags: rare/legendary) с малым шансом и ограничением частоты.

Псевдокод выбора:
```
const candidates = filterByConditions(all, context)
  .filter(notOnCooldown)
  .map(applyVarietyBoost);

if (candidates.length === 0) return fallback();

return weightedSample(candidates, c => c.weight);
```

---

### 5) Изменения в кодовой базе

- `shared/schema.ts`: добавить таблицы `gameThoughts`, `npcDialogueLines`.
- `server/game-data-service.ts`: CRUD для мыслей и для диалогов NPC (помимо уже существующих NPC).
- `src/app/admin/data/actions.ts`: серверные экшены для новых сущностей.
- `src/app/admin/data/page.tsx`: новая вкладка «Мысли»; подтаблица «Реплики» в карточке NPC.
- `src/ai/game-engine.ts`: заменить текущий выбор мыслей на контекстный селектор (см. §4). Для диалогов NPC — аналогичный селектор по `npc_dialogue_lines` при взаимодействиях.

---

### 6) Миграция и наполнение

- Скрипт миграции: перенести часть нынешних `thoughts.ts` в `game_thoughts` с разметкой условий/тегов.
- Для NPC: разделить длинные массивы реплик на отдельные строки в `npc_dialogue_lines` и разметить условиями (локация, время суток, настроение, отношения).
- Добавить несколько «сезонных паков» (halloween, new_year) и редкие «легендарные» наборы.

---

### 7) Анти‑повтор и аналитика

- Анти‑повтор: хранить для героя кольцевой буфер последних M выводов (id или cooldownKey + timestamp).
- Метрики: счётчики показов по id/тегам, CTR «редких», покрытие условий (какие чаще срабатывают), топ‑повторяющиеся.

---

### 8) Этапы внедрения (итеративно)

1) Схема БД + CRUD + вкладка «Мысли» (простые условия: статус/погода/муд/хп/локация) и импорт/экспорт.
2) Интеграция в `game-engine`: контекстный выбор мыслей, анти‑повтор, веса.
3) Таблица `npc_dialogue_lines`, расширение редактора NPC (CRUD, фильтры, импорт/экспорт).
4) Продвинутые условия (время суток, сезон, квестовые флаги, отношения, фракции) + variety‑boost.
5) Контент‑пакеты (сезонные, мемные, региональные), локализация.

---

### 9) Риски и откаты

- Производительность: индексы по (npcId), по tags (GIN), по условиям (частично, через предикаты). Кэширование отфильтрованных наборов на тик.
- Контент‑качество: предпросмотр условий в админке («Протестировать на герое X»), статические линтеры JSON.
- Откат: фича‑флаги (isEnabled), быстрое выключение новых наборов.


