### AI Policy (Simplified, Godville-like)

Этот документ кратко описывает новую упрощённую политику выбора действий героя.

#### Ключевые принципы
- Жёсткие preconditions у действий остаются (нельзя торговать без торговца, спать в бою и т.п.).
- Выбор действия — взвешенный случайный (weighted random) с бустом разнообразия (variety boost).
- Анти‑повтор: чаще выбираются категории, редко встречавшиеся в последних тиках.
- Всегда есть безопасный fallback (`wander`).

#### Где смотреть в коде
- Конфиг весов и параметров: `src/ai/policy.config.ts`.
- Политика и выбор: `src/ai/policy.ts` (weightedSample, applyVarietyBoost, selectActionSimple).
- Наборы действий: экспорт из `src/ai/brain.ts` (`idleActions`, `combatActions`, `deadActions`, `exploringActions`).
- Каталог (фасад): `src/ai/action-catalog.ts` (собирает actions из наборов).

#### Настраиваемые параметры (policy.config)
- `categoryBaseWeights`: базовые веса категорий (`combat`, `quest`, `explore`, `travel`, `rest`, `learn`, `social`, `trading`, `misc`, `system`).
- `recentWindow`: сколько последних действий учитывать для разнообразия.
- `minChoices`: минимальное число кандидатов (на будущее, пока не используется жёстко).
- `maxCooldownMs`: хук для будущей интеграции кулдаунов.
- `systemBaseline`: минимальный базовый вес для системных действий, чтобы они иногда выполнялись (например, авто‑экипировка).

Текущие отличия:
- Выделена категория `trading` (отдельная от `social`).
- Добавлен `systemBaseline`, чтобы `equipBestGear` периодически срабатывал при `autoEquip`.

#### Как тюнить веса после телеметрии
1) Соберите минимальную телеметрию по категориям: распределение выбранных категорий за N тиков на 1000+ героев (или одного долгоиграющего).
2) Если категория недопредставлена — увеличьте её базовый вес (`categoryBaseWeights[category] += 0.05 … 0.2`).
3) Если категория чаще желаемого — уменьшите базовый вес.
4) Для `rest`: снижайте осторожно (например, 0.7 → 0.6), чтобы не загонять героя в истощение.
5) Для `system`: повышайте `systemBaseline`, если нужно чаще переодевать/авто‑эквипать.

Рекомендованные стартовые коррекции (при жалобах на повторения):
- Слегка повышать `quest` (например, +0.05) и `explore` (+0.05), если квестов мало.
- Уменьшить `rest` (-0.05) и/или `travel` (-0.05), если слишком много «пустых» тиков.

#### Тестирование
- Юнит‑тесты по политике: `tests/policy.test.ts` (распределение, variety‑boost, baseline system, баланс social/trading).
- Запуск: `npm run test`.

#### Будущее развитие
- Расширить аналитику: счётчики по категориям на персонажа/сессию; отчёты по распределению.
- Ввести кулдауны на уровне категорий/действий.
- Переезд мыслей/диалогов в БД (`game_thoughts`, `npc_dialogue_lines`) и контекстный выбор — см. `idea1.md`.


